<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Selling Service Client</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    button, input {
      margin: 10px 0;
      padding: 10px;
      font-size: 16px;
    }
    input {
      width: 300px;
    }
    .section {
      margin-bottom: 30px;
    }
  </style>
</head>
<body>
<h1> Selling Service </h1>

<div class="section">
  <h2>ğŸ‘¤ ì‚¬ìš©ì</h2>
  <div style="display: flex; gap: 8px; align-items: center;">
    <button onclick="navigate('/api/users/me')">ë‚´ ì •ë³´</button>
    <button onclick="location.href='/signup'">íšŒì›ê°€ì…</button>
    <button onclick="window.location.href='/login'">ë¡œê·¸ì¸</button>
    <button onclick="location.href='/update'">íšŒì› ì •ë³´ ìˆ˜ì •</button>

    <form action="/logout" method="POST" style="margin: 0;">
      <button type="submit">ë¡œê·¸ì•„ì›ƒ</button>
    </form>

    <button id="deleteUserBtn">íšŒì› íƒˆí‡´</button>
  </div>
</div>

<div class="section">
  <h2>â­ ì¦ê²¨ì°¾ê¸°</h2>
  <button onclick="navigate('/api/favorites')">ì¦ê²¨ì°¾ê¸° ëª©ë¡</button>
</div>

<div class="section">
  <h2>ğŸ“¦ íŒë§¤ ì •ë³´</h2>
  <button onclick="loadAllSales()">ì „ì²´ íŒë§¤ ëª©ë¡</button>

  <div>
    <h3>ğŸ” ë§ˆì¼“ ê¸°ì¤€ ì •ë ¬</h3>
    <input type="text" id="marketInput" placeholder="ë§ˆì¼“ ì´ë¦„ ì…ë ¥" />
    <button onclick="searchMarket()">ê²€ìƒ‰</button>
  </div>

  <div>
    <h3>ğŸ” ìƒí’ˆ ê¸°ì¤€ ì •ë ¬</h3>
    <input type="text" id="productInput" placeholder="ìƒí’ˆ ì´ë¦„ ì…ë ¥" />
    <button onclick="searchProduct()">ê²€ìƒ‰</button>
  </div>

  <ul id="itemList"></ul>
</div>

<div class="section">
  <h2>ğŸŸ¢ ë„¤ì´ë²„ ë¡œê·¸ì¸</h2>
  <button onclick="navigateToNaverLogin()">ë„¤ì´ë²„ ë¡œê·¸ì¸ ì‹œì‘</button>
</div>

<script>
  function navigate(url, method = 'GET') {
    if (method === 'GET') {
      window.open(url, '_blank');
    } else {
      fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      })
      .then(res => alert(`${method} ${url} â†’ ìƒíƒœ: ${res.status}`))
      .catch(err => console.error(err));
    }
  }

  async function toggleFavorite(item, buttonElement) {
    const favoriteDto = {
      product_cd: item.spm_no,
      market_cd: item.whsl_mrkt_cd,
      trd_clcln_ymd: item.trd_clcln_ymd,
      scsbd_prc: item.scsbd_prc
    };

    try {
      const res = await fetch('/api/favorites', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(favoriteDto)
      });

      if (!res.ok) throw new Error("ì¦ê²¨ì°¾ê¸° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨");

      // í˜„ì¬ ë²„íŠ¼ í…ìŠ¤íŠ¸ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë°˜ëŒ€ í…ìŠ¤íŠ¸ë¡œ í† ê¸€
      const isCurrentlyFavorited = buttonElement.innerText.includes('ì·¨ì†Œ');
      buttonElement.innerText = isCurrentlyFavorited ? 'â­ ì¦ê²¨ì°¾ê¸°' : 'â­ ì¦ê²¨ì°¾ê¸° ì·¨ì†Œ';

      alert(isCurrentlyFavorited ? "ì¦ê²¨ì°¾ê¸°ê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤." : "ì¦ê²¨ì°¾ê¸°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch (err) {
      console.error('ì¦ê²¨ì°¾ê¸° ì²˜ë¦¬ ì˜¤ë¥˜:', err);
      alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
    }
  }

  function renderItems(items) {
    const list = document.getElementById("itemList");
    list.innerHTML = "";

    items.forEach((item) => {
      const li = document.createElement("li");
      li.id = `item-${item.product_cd}`;

      li.innerHTML = `
        <strong>${item.whsl_mrkt_nm}</strong> - ${item.corp_gds_item_nm} / ${item.pkg_nm} (${item.scsbd_prc}ì›)
        <br>ğŸ“… ë‚™ì°°ì¼: ${item.scsbd_dt} | ì •ì‚°ì¼: ${item.trd_clcln_ymd}
        <br>
        <button onclick='toggleFavorite(${JSON.stringify(item)}, this)'>â­ ì¦ê²¨ì°¾ê¸°</button>
      `;

      list.appendChild(li);
    });
  }

  async function loadAllSales() {
    try {
      const res = await fetch('/api/infos');
      const data = await res.json();
      renderItems(data);
    } catch (err) {
      console.error("ì „ì²´ íŒë§¤ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", err);
    }
  }

  async function searchMarket() {
    const market = document.getElementById("marketInput").value;
    if (!market) return alert("ë§ˆì¼“ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

    try {
      const res = await fetch(`/api/infos/market/${encodeURIComponent(market)}`);
      const data = await res.json();
      renderItems(data);
    } catch (err) {
      console.error("ë§ˆì¼“ ê²€ìƒ‰ ì‹¤íŒ¨:", err);
      alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
    }
  }

  async function searchProduct() {
    const product = document.getElementById("productInput").value;
    if (!product) return alert("ìƒí’ˆ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.");

    try {
      const res = await fetch(`/api/infos/product/${encodeURIComponent(product)}`);
      const data = await res.json();
      renderItems(data);
    } catch (err) {
      console.error("ìƒí’ˆ ê²€ìƒ‰ ì‹¤íŒ¨:", err);
      alert("ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
    }
  }

  function navigateToNaverLogin() {
    //const state = 'custom_state_value'; ?state=${state}
    window.location.href = `/oauth/naver`;
  }

  document.getElementById("deleteUserBtn").addEventListener("click", async () => {
    const password = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:");
    if (!password) return alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ íƒˆí‡´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");

    try {
      const res = await fetch("/api/users/me", {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ password })
      });

      if (res.status === 204) {
        alert("íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        window.location.href = "/";
      } else {
        alert("íƒˆí‡´ ì‹¤íŒ¨! ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
      }
    } catch (err) {
      console.error("íšŒì› íƒˆí‡´ ì˜¤ë¥˜:", err);
      alert("íƒˆí‡´ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
    }
  });
</script>
</body>
</html>
